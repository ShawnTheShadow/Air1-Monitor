name: CI

on:
  push:
  pull_request:
  workflow_dispatch:

env:
  # Gitea‑specific env vars – adjust if your runner does not expose them automatically
  GITEA_API_URL: ${{ secrets.GITEA_API_URL }}   # e.g. https://git.mycompany.com/api/v1
  GITEA_TOKEN: ${{ secrets.GITEA_TOKEN }}      # personal access token with repo:write scope
  GITEA_REPO: ${{ github.repository }}         # owner/repo (works the same as GitHub)
  GITEA_RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

jobs:
  # --------------------------------------------------------------
  # 1️⃣ Lint / format / clippy / test / check
  # --------------------------------------------------------------
  check:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        rust: [stable]               # add beta/nightly if you like
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ matrix.rust }}

      # ---------- Caching ----------
      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-cargo-registry-${{ matrix.rust }}-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache cargo index
        uses: actions/cache@v4
        with:
          path: ~/.cargo/git
          key: ${{ runner.os }}-cargo-index-${{ matrix.rust }}-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache target directory
        uses: actions/cache@v4
        with:
          path: target
          key: ${{ runner.os }}-cargo-target-${{ matrix.rust }}-${{ hashFiles('**/Cargo.lock') }}

      # ---------- Lint & format ----------
      - name: Check formatting
        run: cargo fmt --check

      - name: Run clippy (fail on warnings)
        run: cargo clippy -- -D warnings

      # ---------- Tests ----------
      - name: Run tests (verbose)
        run: cargo test --workspace --verbose

      # ---------- Build check ----------
      - name: Cargo check (type‑checking only)
        run: cargo check

      # ---------- Save logs on failure ----------
      - name: Save test logs (if failure)
        if: failure()
        run: |
          mkdir -p artifacts
          cargo test --workspace --verbose 2>&1 | tee artifacts/test.log
      - name: Upload test logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: test‑logs
          path: artifacts/

  # --------------------------------------------------------------
  # 2️⃣ Security audit (cargo‑audit)
  # --------------------------------------------------------------
  security:
    runs-on: ubuntu-latest
    needs: check
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust (needed for cargo‑audit)
        uses: dtolnay/rust-toolchain@stable

      - name: Run cargo‑audit
        uses: rustsec/audit-check@v2
        with:
          token: ${{ secrets.GITEA_TOKEN }}
          ignore: RUSTSEC-2024-0436
          # Enable caching of the advisory DB (speeds up subsequent runs)
          cache: true

  # --------------------------------------------------------------
  # 3️⃣ Out‑of‑date dependencies (run only on PRs)
  # --------------------------------------------------------------
  outdated:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    needs: check
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install cargo‑outdated (binary)
        run: |
          curl -L https://github.com/kbknapp/cargo-outdated/releases/download/v0.15.0/cargo-outdated-v0.15.0-x86_64-unknown-linux-musl.tar.gz \
            | tar xz -C ~/.cargo/bin

      - name: Run cargo outdated (fail on any outdated crate)
        run: cargo outdated --exit-code 1

  # --------------------------------------------------------------
  # 4️⃣ (Optional) Code coverage with tarpaulin
  # --------------------------------------------------------------
  coverage:
    runs-on: ubuntu-latest
    needs: check
    if: github.event_name != 'push'   # run on PRs / manual dispatch only
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install tarpaulin
        run: cargo install cargo-tarpaulin --locked

      - name: Run coverage
        run: cargo tarpaulin --out Xml

      - name: Upload coverage artifact
        uses: actions/upload-artifact@v4
        with:
          name: coverage‑xml
          path: coverage.xml

  # --------------------------------------------------------------
  # 5️⃣ (Optional) Release build – runs only on tags
  # --------------------------------------------------------------
  release:
    runs-on: ubuntu-latest
    needs: [check, security, outdated]
    if: startsWith(github.ref, 'refs/tags/')
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Build release binary
        run: cargo build --release

      - name: Upload binary as artifact
        uses: actions/upload-artifact@v4
        with:
          name: my‑binary
          path: target/release/*

  # --------------------------------------------------------------
  # 6️⃣ Notify on failure (Gitea API)
  # --------------------------------------------------------------
  notify:
    runs-on: ubuntu-latest
    needs: [check, security, outdated, coverage, release]
    if: failure()
    steps:
      - name: Create issue on failure (Gitea API)
        env:
          GITEA_API_URL: ${{ env.GITEA_API_URL }}
          GITEA_TOKEN: ${{ env.GITEA_TOKEN }}
          GITEA_REPO: ${{ env.GITEA_REPO }}
          GITEA_RUN_URL: ${{ env.GITEA_RUN_URL }}
        run: |
          curl -s -X POST "${GITEA_API_URL}/repos/${GITEA_REPO}/issues" \
            -H "Authorization: token ${GITEA_TOKEN}" \
            -H "Content-Type: application/json" \
            -d "$(cat <<EOF
          {
            "title": "CI failure: ${{ github.workflow }} #${{ github.run_number }}",
            "body": "The CI run failed.\n\nRun details: ${GITEA_RUN_URL}\n\nPlease check the logs attached to the failed jobs."
          }
          EOF
          )"